<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Delivery v53</title>
    <style>
        :root { --p: #30d158; --bg: #1c1c1e; --card: #2c2c2e; --txt: #ffffff; --accent: #30b0c7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: var(--txt); overflow-x: hidden; }
        .nav { display: flex; background: #000; padding-top: 45px; border-bottom: 1px solid #38383a; position: sticky; top: 0; z-index: 100; }
        .nav button { flex: 1; padding: 18px; border: none; background: none; font-weight: 700; color: #8e8e93; font-size: 13px; }
        .nav button.active { color: var(--p); border-bottom: 3px solid var(--p); }
        .container { padding: 16px; max-width: 600px; margin: auto; }
        .btn-main { background: var(--p); color: #000; width: 100%; padding: 20px; font-size: 18px; border-radius: 16px; border: none; font-weight: 800; margin-bottom: 10px; }
       
        /* Î›Î™Î£Î¤Î‘ ÎšÎ‘Î™ ÎšÎ‘Î¡Î¤Î•Î£ */
        .card { background: var(--card); border-radius: 16px; padding: 12px; margin-bottom: 12px; display: flex; align-items: center; border: 1px solid #38383a; touch-action: none; position: relative; }
        .handle { color: #8e8e93; padding: 10px 15px; cursor: grab; font-size: 24px; margin-right: 5px; user-select: none; }
        .num-badge { background: var(--p); color: #000; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px; margin-right: 10px; }
        .info { flex: 1; min-width: 0; pointer-events: none; }
        .info h4 { margin: 0; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info p { margin: 2px 0 0 0; font-size: 12px; color: #8e8e93; }
       
        .btn-edit { background: none; border: none; font-size: 20px; padding: 10px; z-index: 10; }
        .btn-go { background: var(--accent); color: #000; border: none; width: 44px; height: 44px; border-radius: 12px; margin-left: 8px; font-weight: bold; z-index: 10; }
        .btn-del { background: #ff453a; color: #fff; border: none; width: 44px; height: 44px; border-radius: 12px; margin-left: 8px; z-index: 10; }
       
        .dragging { opacity: 0.5; background: #3a3a3c !important; transform: scale(1.02); }
        .hidden { display: none; }
        textarea, input { background: #2c2c2e; border: 1px solid #38383a; color: #fff; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="nav">
    <button id="t1" onclick="tab('run')" class="active">Î”Î™Î‘Î”Î¡ÎŸÎœÎ—</button>
    <button id="t2" onclick="tab('base')">Î Î•Î›Î‘Î¤Î•Î£</button>
    <button id="t3" onclick="tab('set')">âš™ï¸</button>
</div>

<div id="run-page" class="container">
    <button class="btn-main" onclick="startNav()">ğŸš€ NAVIGATION</button>
    <div id="run-list"></div>
    <button onclick="clearRun()" style="width:100%; color:#ff453a; background:none; border:none; padding:20px;">âŒ ÎšÎ‘Î˜Î‘Î¡Î™Î£ÎœÎŸÎ£</button>
</div>

<div id="base-page" class="container hidden">
    <input type="text" id="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." onkeyup="renderBase()">
    <div id="base-list"></div>
</div>

<div id="set-page" class="container hidden">
    <textarea id="bulk" rows="6" placeholder="ÎŒÎ½Î¿Î¼Î± .. Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·"></textarea>
    <button onclick="saveData()" class="btn-main">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('delivery_db') || '[]');
    let rn = JSON.parse(localStorage.getItem('delivery_rn') || '[]');

    function tab(t) {
        document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
        document.getElementById(t + '-page').classList.remove('hidden');
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        if(t==='run') renderRun();
        if(t==='base') renderBase();
        document.getElementById(t==='run'?'t1':t==='base'?'t2':'t3').classList.add('active');
    }

    function renderRun() {
        const list = document.getElementById('run-list'); list.innerHTML = '';
        rn.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.draggable = true;
            div.dataset.index = idx;
            div.innerHTML = `
                <div class="handle">â‰¡</div>
                <div class="num-badge">${idx + 1}</div>
                <div class="info"><h4>${item.n}</h4><p>${item.a}</p></div>
                <button class="btn-edit" onclick="editRun(${idx})">âœï¸</button>
                <button class="btn-go" onclick="window.location.href='comgooglemaps://?daddr='+encodeURIComponent('${item.a}')">GO</button>
                <button class="btn-del" onclick="delRun(${idx})">âœ•</button>`;
           
            // Touch Events Î³Î¹Î± Ï„Î¿ ÎºÎ¹Î½Î·Ï„ÏŒ
            div.addEventListener('touchstart', handleTouchStart, {passive: false});
            div.addEventListener('touchmove', handleTouchMove, {passive: false});
            div.addEventListener('touchend', handleTouchEnd);
           
            list.appendChild(div);
        });
    }

    // ÎœÎ·Ï‡Î±Î½Î¹ÏƒÎ¼ÏŒÏ‚ Drag & Drop Î³Î¹Î± ÎºÎ¹Î½Î·Ï„Î¬ (Î§Ï‰ÏÎ¯Ï‚ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ® Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·)
    let dragItem = null;
    let startY = 0;

    function handleTouchStart(e) {
        if (!e.target.classList.contains('handle')) return;
        dragItem = e.currentTarget;
        dragItem.classList.add('dragging');
        startY = e.touches[0].clientY;
    }

    function handleTouchMove(e) {
        if (!dragItem) return;
        e.preventDefault();
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const container = document.getElementById('run-list');
        const afterElement = getDragAfterElement(container, touch.clientY);
        if (afterElement == null) {
            container.appendChild(dragItem);
        } else {
            container.insertBefore(dragItem, afterElement);
        }
    }

    function handleTouchEnd() {
        if (!dragItem) return;
        dragItem.classList.remove('dragging');
        // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î½Î­Î±Ï‚ ÏƒÎµÎ¹ÏÎ¬Ï‚
        let newRn = [];
        document.querySelectorAll('#run-list .card').forEach(el => {
            const oldIdx = el.dataset.index;
            newRn.push(rn[oldIdx]);
        });
        rn = newRn;
        localStorage.setItem('delivery_rn', JSON.stringify(rn));
        dragItem = null;
        renderRun();
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renderBase() {
        const s = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('base-list'); list.innerHTML = '';
        db.forEach((item, i) => {
            if(item.n.toLowerCase().includes(s) || item.a.toLowerCase().includes(s)) {
                const div = document.createElement('div'); div.className = 'card';
                div.innerHTML = `<div class="info" style="pointer-events:auto"><h4>${item.n}</h4><p>${item.a}</p></div>
                    <button class="btn-edit" onclick="editBase(${i})">âœï¸</button>
                    <button style="background:var(--p); border:none; width:44px; height:44px; border-radius:12px; font-weight:bold;" onclick="addToRun(${i})">+</button>
                    <button class="btn-del" onclick="delBase(${i})">âœ•</button>`;
                list.appendChild(div);
            }
        });
    }

    function editBase(i) {
        const n = prompt("ÎŒÎ½Î¿Î¼Î±:", db[i].n); const a = prompt("Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:", db[i].a);
        if(n && a) { db[i] = {n, a}; localStorage.setItem('delivery_db', JSON.stringify(db)); renderBase(); }
    }

    function editRun(i) {
        const n = prompt("ÎŒÎ½Î¿Î¼Î±:", rn[i].n); const a = prompt("Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:", rn[i].a);
        if(n && a) { rn[i] = {n, a}; localStorage.setItem('delivery_rn', JSON.stringify(rn)); renderRun(); }
    }

    function addToRun(i) { rn.push({...db[i]}); localStorage.setItem('delivery_rn', JSON.stringify(rn)); alert('Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!'); }
    function delRun(i) { rn.splice(i,1); localStorage.setItem('delivery_rn', JSON.stringify(rn)); renderRun(); }
    function delBase(i) { if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î®;')){db.splice(i,1); localStorage.setItem('delivery_db', JSON.stringify(db)); renderBase();}}
    function clearRun() { if(confirm('Î£Î²Î®ÏƒÎ¹Î¼Î¿;')){ rn=[]; localStorage.setItem('delivery_rn', JSON.stringify(rn)); renderRun(); } }
   
    function startNav() {
        if(!rn.length) return;
        window.location.href = "comgooglemaps://?saddr=&daddr=" + encodeURIComponent(rn.map(i=>i.a).join(' to:'));
    }

    function saveData() {
        document.getElementById('bulk').value.split('\n').forEach(line => {
            const p = line.split('..'); if(p.length >= 2) db.push({ n: p[0].trim(), a: p[1].trim() });
        });
        localStorage.setItem('delivery_db', JSON.stringify(db)); document.getElementById('bulk').value = ''; tab('base');
    }

    tab('run');
</script>
</body>
</html>
